## ID: 400001

## HF

## Source: IDS

## Category: Malware

## Description: Windows FTPD Buffer Overflow

## Objective Statement:
This alert is for a vulnerability where an attacker can cause what is known as a buffer overflow, which is when a program expects a certain maximum size of input but receives more. As a result an attacker  can execute code. 
The attacker will be able execute commands with the same privileges as the FTP service, because this is Windows, it is likely to have administrator privileges.

## Result Analysis:
Buffer Overflows all an attacker to overflow the allocated memory for a variable that gets set, or involves user input that is unchecked, the attacker can then overwrite the memory and in turn the instructions that the system will execute. This can be used to enter code that spawns a shell.  From there the attacker has command line access, if they are not administrator there are many ways to escalate privileges.
The system should be considered compromised. To investigate check the FTP logs and windows events logs. The FTP service would have crashed will be indicated in some of the logs. Check firewall, network and IDS logs. The attacker would have needed to use an alternate port to create the shell. Look for odd ports, or ports that are common like web that do not contain web traffic.


Sample of the Windows system logs that shows the application crashing
```
ModLoad: 72090000 720be000   C:\Windows\system32\mlang.dll
ModLoad: 75090000 7509b000   C:\Windows\system32\pcwum.DLL
ModLoad: 75a70000 75a7e000   C:\Windows\system32\RpcRtRemote.dll
(22c.c10): Break instruction exception - code 80000003 (first chance)
eax=7ffaf000 ebx=00000000 ecx=00000000 edx=779cd315 esi=00000000 edi=00000000
eip=77963574 esp=00ccfc38 ebp=00ccfc64 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Windows\SYSTEM32\ntdll.dll -
ntdll!DbgBreakPoint:
77963574 cc              int     3
0:012> g
(22c.31c): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000000 ebx=0000003c ecx=0050291c edx=0000003b esi=005e5fc0 edi=00500000
eip=77986167 esp=00abf6b4 ebp=00abf794 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246
ntdll!RtlPrefixUnicodeString+0x84c:
77986167 8b4814          mov     ecx,dword ptr [eax+14h] ds:0023:00000014=????????
0:006> g
(22c.31c): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=005e5fc8 ebx=005e7fc8 ecx=b083ef27 edx=efb083ef esi=005e5fc0 edi=00500000
eip=77986030 esp=00abf674 ebp=00abf69c iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246
ntdll!RtlPrefixUnicodeString+0x715:
77986030 8b4904          mov     ecx,dword ptr [ecx+4] ds:0023:b083ef2b=????????
0:006> g
Critical error detected c0000374
(22c.31c): Break instruction exception - code 80000003 (first chance)
eax=00000000 ebx=00000000 ecx=77950805 edx=00abe7a9 esi=00500000 edi=00515520
eip=779f28e5 esp=00abe9fc ebp=00abea74 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
ntdll!RtlpNtMakeTemporaryKey+0x1a49:

7798c64e 8b4714          mov     eax,dword ptr [edi+14h] ds:0023:00000014=????????
0:006> g
```


*References for Futher Learning*

- https://www.rapid7.com/db/modules/auxiliary/dos/windows/ftp/iis75_ftpd_iac_bof
- https://www.exploit-db.com/exploits/15803/
- http://www.cvedetails.com/cve/cve-2010-3972 
- https://blogs.technet.microsoft.com/srd/2010/12/22/assessing-an-iis-ftp-7-5-unauthenticated-denial-of-service-vulnerability/

## Mitigation

- There are patches available for the affected service. Patch the service.

## Data Query Code
- FTPD Buffer overflow
- Remote code execution
- Denial of Service
